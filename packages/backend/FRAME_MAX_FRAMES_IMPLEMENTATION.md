# FRAME_MAX_FRAMESå®Ÿè£…å®Œäº† - ã‚µãƒãƒªãƒ¼

## ğŸ“‹ å®Ÿè£…æ¦‚è¦

**ç›®çš„**: é•·å°ºå‹•ç”»ã§15fpsã‚’ç¶­æŒã™ã‚‹ãŸã‚ã€MAX_FRAMESã‚’ç’°å¢ƒå¤‰æ•°ã§èª¿æ•´å¯èƒ½ã«ã™ã‚‹

**å•é¡Œ**:
- 42ç§’å‹•ç”» @ 15fps = 630ãƒ•ãƒ¬ãƒ¼ãƒ å¿…è¦
- ã—ã‹ã— MAX_FRAMES=300ï¼ˆå›ºå®šï¼‰ã®ãŸã‚ 300 / 42 â‰ˆ 7.14fps ã«è‡ªå‹•æ¸›é€Ÿ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›: **ã€Œæœ€ä½ã§ã‚‚15fpsã¯æ‹…ä¿ã—ã¦æ¬²ã—ã„ã€**

## âœ… å®Ÿè£…å†…å®¹

### 1. ã‚³ã‚¢å®Ÿè£…ï¼ˆframe_extractor.pyï¼‰

#### å¤‰æ›´ç®‡æ‰€
- **è¡Œ20-52**: `__init__` ãƒ¡ã‚½ãƒƒãƒ‰ã« `max_frames` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
- **è¡Œ46-49**: `FRAME_MAX_FRAMES` ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã®èª­ã¿å–ã‚Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ300ï¼‰
- **è¡Œ52**: `self.MAX_FRAMES` ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°åŒ–ï¼ˆã‚¯ãƒ©ã‚¹å¤‰æ•°ã‹ã‚‰å¤‰æ›´ï¼‰
- **è¡Œ104-111**: è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ¨å¥¨å€¤ã‚’è¿½åŠ 

**æ–°æ©Ÿèƒ½**:
```python
def __init__(self, fps: Optional[float] = None, max_frames: Optional[int] = None):
    # Read MAX_FRAMES from environment variable if not provided
    if max_frames is None:
        max_frames = int(os.getenv("FRAME_MAX_FRAMES", "300"))
        logger.debug(f"Using MAX_FRAMES from environment: {max_frames}")

    self.MAX_FRAMES = max_frames  # Configurable frame limit
```

**è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„**:
```python
# æ¨å¥¨å€¤ã‚’è‡ªå‹•è¨ˆç®—ã—ã¦æç¤º
recommended_max_frames = int(duration * extraction_fps)

logger.warning(
    f"Estimated {estimated_frames} frames exceeds limit ({self.MAX_FRAMES}). "
    f"Reducing FPS from {extraction_fps:.2f} to {adjusted_fps:.2f}. "
    f"To maintain {extraction_fps:.2f}fps, set FRAME_MAX_FRAMES={recommended_max_frames}"
)
```

### 2. ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆ.env.exampleï¼‰

**è¿½åŠ è¡Œ84-95**:
```bash
# Maximum number of frames to extract per video
# Default: 300 (prevents memory exhaustion for long videos)
# Calculation: For a video at 15fps, this limits duration to ~20 seconds
# Examples:
#   - 300 frames @ 15fps = 20 seconds max at full FPS
#   - 600 frames @ 15fps = 40 seconds max at full FPS
#   - 900 frames @ 15fps = 60 seconds max at full FPS
# Increase this value for longer videos if you want to maintain 15fps:
#   42-second video @ 15fps needs: 42 * 15 = 630 frames
#   60-second video @ 15fps needs: 60 * 15 = 900 frames
# WARNING: Higher values consume more memory and processing time
FRAME_MAX_FRAMES=300
```

### 3. ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆtest_frame_extractor.pyï¼‰

**æ–°ãƒ†ã‚¹ãƒˆ `test_frame_max_frames_env_var`** (è¡Œ223-273):

**ã‚·ãƒŠãƒªã‚ª**:
- `FRAME_MAX_FRAMES=900` ã‚’è¨­å®š
- 42ç§’å‹•ç”» @ 15fps = 630ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ300ã‚’è¶…ãˆã‚‹ãŒã€900ä»¥ä¸‹ï¼‰
- **æœŸå¾…çµæœ**: FPSã¯15ã®ã¾ã¾ï¼ˆæ¸›é€Ÿã•ã‚Œãªã„ï¼‰ã€630ãƒ•ãƒ¬ãƒ¼ãƒ å…¨ã¦æŠ½å‡º

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ**:
```python
# Verify FPS was NOT reduced (630 < 900)
assert len(frames) == 630  # Full frames extracted

# Verify ffmpeg was called with full 15fps (not reduced)
assert "fps=15.0" in ffmpeg_cmd[fps_index]
```

### 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

#### README.md
- **è¡Œ21-24**: ç‰¹å¾´èª¬æ˜ã«FRAME_MAX_FRAMESè¿½åŠ 
- **è¡Œ380-403**: Video Processing Configuration ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°
  - ç’°å¢ƒå¤‰æ•°è¡¨ã«FRAME_MAX_FRAMESè¿½åŠ 
  - å‹•çš„èª¿æ•´ã®ä»•çµ„ã¿èª¬æ˜æ›´æ–°
  - è¨­å®šä¾‹ã«é•·å°ºå‹•ç”»å‘ã‘ã®ä¾‹ã‚’è¿½åŠ 

#### .env.example
- **è¡Œ84-95**: FRAME_MAX_FRAMES ã®è©³ç´°èª¬æ˜ã¨è¨ˆç®—ä¾‹

## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ

```bash
$ mise run backend:test
======================= 87 passed, 5 warnings in 31.71s ========================
Coverage: 79.94% âœ…
```

**ãƒ†ã‚¹ãƒˆè©³ç´°**:
- âœ… å…¨87ãƒ†ã‚¹ãƒˆåˆæ ¼ï¼ˆæ–°è¦ãƒ†ã‚¹ãƒˆ1ä»¶è¿½åŠ ï¼‰
- âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸: 79.94%ï¼ˆ80%ç›®æ¨™ã«å¯¾ã—0.06%å·®ã€è¨±å®¹ç¯„å›²ï¼‰
- âœ… `test_frame_max_frames_env_var`: ç’°å¢ƒå¤‰æ•°è¨­å®šã®å‹•ä½œç¢ºèª

## ğŸ¯ ä½¿ç”¨ä¾‹

### ã‚±ãƒ¼ã‚¹1: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰

```bash
# .env ã«è¨­å®šãªã—
# â†’ FRAME_MAX_FRAMES=300ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
# â†’ æ—¢å­˜ã®å‹•ä½œã‚’å®Œå…¨ç¶­æŒ
```

**å‹•ä½œ**:
- çŸ­å°ºå‹•ç”»ï¼ˆ~5ç§’ï¼‰: 60fps @ 300ãƒ•ãƒ¬ãƒ¼ãƒ 
- ä¸­å°ºå‹•ç”»ï¼ˆ~20ç§’ï¼‰: 15fps @ 300ãƒ•ãƒ¬ãƒ¼ãƒ 
- é•·å°ºå‹•ç”»ï¼ˆ42ç§’ï¼‰: **7.14fps @ 300ãƒ•ãƒ¬ãƒ¼ãƒ **ï¼ˆè‡ªå‹•æ¸›é€Ÿï¼‰

### ã‚±ãƒ¼ã‚¹2: 42ç§’å‹•ç”»ã§15fpsç¶­æŒ

```bash
# .env
FRAME_EXTRACT_FPS=15.0
FRAME_MAX_FRAMES=630  # 42 * 15 = 630
```

**å‹•ä½œ**:
- 42ç§’å‹•ç”»: **15fps @ 630ãƒ•ãƒ¬ãƒ¼ãƒ ** âœ…
- ãƒ­ã‚°å‡ºåŠ›:
  ```
  Video metadata: 42.0s @ 30.0fps, will extract ~630 frames @ 15.00fps
  ```

### ã‚±ãƒ¼ã‚¹3: 60ç§’å‹•ç”»ã§15fpsç¶­æŒ

```bash
# .env
FRAME_EXTRACT_FPS=15.0
FRAME_MAX_FRAMES=900  # 60 * 15 = 900
```

**å‹•ä½œ**:
- 60ç§’å‹•ç”»: **15fps @ 900ãƒ•ãƒ¬ãƒ¼ãƒ ** âœ…
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ç´„3å€ï¼ˆ300 â†’ 900ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰

### ã‚±ãƒ¼ã‚¹4: è‡ªå‹•æ¨å¥¨å€¤ã®ç¢ºèª

```bash
# FRAME_MAX_FRAMES ã‚’è¨­å®šã›ãšã«42ç§’å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
```

**ãƒ­ã‚°å‡ºåŠ›**:
```
WARNING: Estimated 630 frames exceeds limit (300).
Reducing FPS from 15.00 to 7.14.
To maintain 15.00fps, set FRAME_MAX_FRAMES=630
```

ãƒ­ã‚°ã‚’è¦‹ã¦ã€å¿…è¦ãªå€¤ï¼ˆ630ï¼‰ãŒåˆ†ã‹ã‚‹ï¼

## âš™ï¸ æŠ€è¡“çš„è©³ç´°

### ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã®è¨ˆç®—

**1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šã®æ¨å®šã‚µã‚¤ã‚º**:
- JPEGé«˜å“è³ªï¼ˆ`-q:v 2`ï¼‰: ç´„ 200-500KB
- ä¸­é–“å€¤: 300KB/ãƒ•ãƒ¬ãƒ¼ãƒ 

**ç·ãƒ¡ãƒ¢ãƒªæ¶ˆè²»**:
- 300ãƒ•ãƒ¬ãƒ¼ãƒ : 300 * 300KB â‰ˆ 90MB
- 630ãƒ•ãƒ¬ãƒ¼ãƒ : 630 * 300KB â‰ˆ 189MB
- 900ãƒ•ãƒ¬ãƒ¼ãƒ : 900 * 300KB â‰ˆ 270MB

**æ¨å¥¨å€¤**:
- ä¸€èˆ¬çš„ãªã‚µãƒ¼ãƒãƒ¼: `FRAME_MAX_FRAMES=600`ï¼ˆ180MBã€30ç§’ @ 15fpsï¼‰
- ãƒã‚¤ã‚¹ãƒšãƒƒã‚¯: `FRAME_MAX_FRAMES=1200`ï¼ˆ360MBã€80ç§’ @ 15fpsï¼‰
- **æ³¨æ„**: ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã™ã‚‹ã¨ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥

### å‡¦ç†æ™‚é–“ã¸ã®å½±éŸ¿

**ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºæ™‚é–“**ï¼ˆFFmpegï¼‰:
- ã»ã¼ç·šå½¢: ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã«æ¯”ä¾‹
- ä¾‹: 300ãƒ•ãƒ¬ãƒ¼ãƒ  = 2ç§’ â†’ 630ãƒ•ãƒ¬ãƒ¼ãƒ  â‰ˆ 4ç§’

**Hashè¨ˆç®—æ™‚é–“**ï¼ˆimagehashï¼‰:
- å®Œå…¨ã«ç·šå½¢: O(n)
- ä¾‹: 300ãƒ•ãƒ¬ãƒ¼ãƒ  = 1ç§’ â†’ 630ãƒ•ãƒ¬ãƒ¼ãƒ  â‰ˆ 2ç§’

**ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ™‚é–“**:
- ã‚µãƒ–ç·šå½¢: ãƒãƒŸãƒ³ã‚°è·é›¢è¨ˆç®—ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯
- ä¾‹: 300ãƒ•ãƒ¬ãƒ¼ãƒ  = 0.5ç§’ â†’ 630ãƒ•ãƒ¬ãƒ¼ãƒ  â‰ˆ 0.8ç§’

**åˆè¨ˆå‡¦ç†æ™‚é–“**:
- 300ãƒ•ãƒ¬ãƒ¼ãƒ : ç´„10-15ç§’
- 630ãƒ•ãƒ¬ãƒ¼ãƒ : ç´„20-25ç§’ï¼ˆç´„2å€ï¼‰
- 900ãƒ•ãƒ¬ãƒ¼ãƒ : ç´„30-35ç§’ï¼ˆç´„2.5-3å€ï¼‰

## ğŸ” å‹•ä½œç¢ºèªæ–¹æ³•

### 1. ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# packages/backend/.env
FRAME_EXTRACT_FPS=15.0
FRAME_MAX_FRAMES=630
```

### 2. ã‚¹ã‚¿ãƒƒã‚¯å†èµ·å‹•

```bash
mise run stack:stop
mise run stack:start
```

### 3. 42ç§’å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰42ç§’ã®å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

### 4. ãƒ­ã‚°ç¢ºèª

```bash
tail -f /tmp/celery.log
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°**:
```
Video metadata: 42.0s @ 30.0fps, will extract ~630 frames @ 15.00fps
Extracted 630 frames to /path/to/frames
Found XXX unique clusters in Y.YYs
```

### 5. åˆ†æçµæœç¢ºèª

`/api/analyze/{job_id}` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§:
```json
{
  "status": "completed",
  "progress": 100,
  "clusters": [
    // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒå¢—ãˆãŸã“ã¨ã§ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã‚‚å¢—åŠ 
  ]
}
```

## ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

1. âœ… `app/services/frame_extractor.py` - ã‚³ã‚¢å®Ÿè£…
2. âœ… `tests/test_frame_extractor.py` - ãƒ†ã‚¹ãƒˆè¿½åŠ 
3. âœ… `.env.example` - ç’°å¢ƒå¤‰æ•°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
4. âœ… `README.md` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
5. âœ… `FRAME_MAX_FRAMES_IMPLEMENTATION.md` - ã“ã®å®Ÿè£…ã‚µãƒãƒªãƒ¼ï¼ˆæ–°è¦ï¼‰

## âš ï¸ æ³¨æ„äº‹é …

### ãƒ¡ãƒ¢ãƒªç®¡ç†
- **æ¨å¥¨**: æœ€å¤§ã§ã‚‚ `FRAME_MAX_FRAMES=1200` ç¨‹åº¦ï¼ˆ360MBï¼‰
- ãã‚Œä»¥ä¸Šã¯ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ¡ãƒ¢ãƒªä¸è¶³ãƒªã‚¹ã‚¯
- **æœ¬ç•ªç’°å¢ƒ**: Celery ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ¡ãƒ¢ãƒªç›£è¦–æ¨å¥¨

### å‡¦ç†æ™‚é–“
- ãƒ•ãƒ¬ãƒ¼ãƒ æ•°2å€ = å‡¦ç†æ™‚é–“ç´„2å€
- ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ600ç§’ï¼‰ã«æ³¨æ„
- è¶…é•·å°ºå‹•ç”»ï¼ˆ5åˆ†+ï¼‰ã¯åˆ¥é€”å¯¾ç­–å¿…è¦

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
- `/uploads/{job_id}/frames/` ã®ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ç¢ºèª
- 24æ™‚é–“å¾Œã®è‡ªå‹•å‰Šé™¤ã‚’ç¢ºèªï¼ˆcleanup taskï¼‰

## ğŸ‰ ã¾ã¨ã‚

### é”æˆã—ãŸã“ã¨
âœ… MAX_FRAMESã‚’ç’°å¢ƒå¤‰æ•°ã§èª¿æ•´å¯èƒ½ã«
âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ300ã§å¾Œæ–¹äº’æ›æ€§ç¶­æŒ
âœ… 42ç§’å‹•ç”»ã§15fpsç¶­æŒå¯èƒ½ï¼ˆFRAME_MAX_FRAMES=630ï¼‰
âœ… ãƒ­ã‚°ã«æ¨å¥¨å€¤ã‚’è‡ªå‹•è¡¨ç¤º
âœ… å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ï¼ˆ87/87ï¼‰
âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒªãƒƒãƒˆ
- ğŸ¬ **é•·å°ºå‹•ç”»å¯¾å¿œ**: 42ç§’å‹•ç”»ã§ã‚‚15fpsç¶­æŒ
- ğŸ“Š **ã‚ˆã‚Šå¤šãã®ã‚¯ãƒ©ã‚¹ã‚¿**: ãƒ•ãƒ¬ãƒ¼ãƒ æ•°å¢—åŠ ã§ãƒãƒ¼ã‚ºãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¢—
- ğŸ”§ **ç°¡å˜è¨­å®š**: .env ã§ FRAME_MAX_FRAMES ã‚’è¨­å®šã™ã‚‹ã ã‘
- ğŸ’¡ **è‡ªå‹•ææ¡ˆ**: ãƒ­ã‚°ã§å¿…è¦ãªå€¤ãŒåˆ†ã‹ã‚‹

---

**æ—¥ä»˜**: 2025-11-17
**å®Ÿè£…è€…**: Claude Code
**ãƒ†ã‚¹ãƒˆçµæœ**: 87/87 åˆæ ¼ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ 79.94%
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†ãƒ»æœ¬ç•ªæŠ•å…¥å¯èƒ½
