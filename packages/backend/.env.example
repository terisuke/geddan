# DanceFrame Backend Environment Variables
# Copy this file to .env and customize for your environment

# ========================================
# Application Settings
# ========================================

# DEBUG mode - enables detailed logging and makes Redis optional
# Set to "true" for local development
DEBUG=true

# Secret key for session encryption (change in production)
SECRET_KEY=dev-secret-key-change-me-in-production

# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# ========================================
# Redis Configuration
# ========================================

# Redis connection - OPTIONAL in development mode
# When DEBUG=true or REDIS_OPTIONAL=true, the backend will start without Redis
# Production should set REDIS_OPTIONAL=false to ensure Redis is available

# Option 1: Use REDIS_URL (Docker Compose / Railway)
# REDIS_URL=redis://localhost:6379/0

# Option 2: Use separate host/port (Local development)
REDIS_HOST=localhost
REDIS_PORT=6379

# Make Redis optional (true/false)
# Default: true (allows local development without Redis)
# Production: false (require Redis for task queue)
REDIS_OPTIONAL=true

# ========================================
# Celery Configuration
# ========================================

# Celery broker and result backend
# Uses Redis by default - if Redis is unavailable and optional, Celery tasks won't run
CELERY_BROKER_URL=redis://localhost:6379/0
CELERY_RESULT_BACKEND=redis://localhost:6379/0

# Task time limits (seconds)
TASK_TIME_LIMIT=600
TASK_SOFT_TIME_LIMIT=540

# ========================================
# CORS Configuration
# ========================================

# Allowed origins for CORS (comma-separated)
# Development: http://localhost:3000,http://localhost:3001
# Production: https://danceframe.app
CORS_ORIGINS=http://localhost:3000,http://localhost:3001

# ========================================
# File Upload Settings
# ========================================

# Maximum upload file size (bytes)
# Default: 104857600 (100MB)
MAX_UPLOAD_SIZE=104857600

# File retention period (hours)
# Uploaded files and generated videos are auto-deleted after this period
FILE_RETENTION_HOURS=24

# ========================================
# Video Processing Settings
# ========================================

# Frame extraction FPS (frames per second)
# Default: 60.0 (YouTube standard, maximum detail)
# Range: 1-60 (higher = more frames, better pose coverage)
# Dynamic adjustment: Automatically reduced for longer videos to respect FRAME_MAX_FRAMES
# Examples with default FRAME_MAX_FRAMES=300:
#   - 5-second video: 60fps (300 frames)
#   - 10-second video: 30fps (300 frames, auto-adjusted)
#   - 20-second video: 15fps (300 frames, auto-adjusted)
#   - 42-second video: 7.1fps (300 frames, auto-adjusted)
# Note: Short videos get maximum detail, long videos automatically adapt
FRAME_EXTRACT_FPS=60.0

# Maximum number of frames to extract per video
# Default: 3600 (supports up to 1 minute @ 60fps)
# Memory consumption: ~1.08GB (3600 frames × 300KB/frame)
# Examples with FRAME_MAX_FRAMES=3600:
#   - 1-minute video: 60fps (3600 frames, full YouTube quality)
#   - 2-minute video: 30fps (3600 frames, auto-adjusted)
#   - 4-minute video: 15fps (3600 frames, auto-adjusted)
# For shorter videos with less memory:
#   - FRAME_MAX_FRAMES=1800 → 30s @ 60fps, 1min @ 30fps (~540MB)
#   - FRAME_MAX_FRAMES=900 → 15s @ 60fps, 30s @ 30fps (~270MB)
#   - FRAME_MAX_FRAMES=300 → 5s @ 60fps, 10s @ 30fps (~90MB)
# WARNING: Higher values consume more memory (300KB/frame × count)
FRAME_MAX_FRAMES=3600

# Perceptual hash clustering threshold (Hamming distance)
# Default: 6 (looser clustering, merges similar poses into same cluster)
# Range: 1-10 (lower = more clusters, higher = fewer clusters)
# How it works:
#   - Compares frames using perceptual hashing (imagehash.phash)
#   - Frames with Hamming distance ≤ threshold are grouped into same cluster
#   - Higher threshold = looser matching = merges similar poses (reduces cluster count)
#   - Lower threshold = stricter matching = separates similar poses (increases cluster count)
# Recommended values for 60fps videos:
#   - 5: Original default (may create too many clusters with 60fps)
#   - 6: Recommended default (merges similar consecutive frames, ~20 clusters)
#   - 7: Looser (further reduces cluster count, risk of merging different poses)
#   - 4 or lower: Stricter (creates many clusters, same pose split across multiple clusters)
# Note: With 60fps extraction, similar consecutive frames increase dramatically
#       Using threshold=6 instead of 5 merges these duplicates into single clusters
HASH_HAMMING_THRESHOLD=6

# ========================================
# Server Configuration
# ========================================

# Server host and port
HOST=0.0.0.0
PORT=8000

# Number of Uvicorn workers (production)
WORKERS=4

# ========================================
# Development Options
# ========================================

# Disable auto-reload for uvicorn (if you encounter "Operation not permitted")
# Use: uvicorn app.main:app --port 8000 (without --reload)
# UVICORN_NO_RELOAD=true

# Watchfiles exclusion patterns (prevent infinite reload)
# Comma-separated glob patterns
WATCHFILES_EXCLUDE=*.log,*.tmp,uploads/**,outputs/**,__pycache__/**,*.pyc,.pytest_cache/**,.coverage

# ========================================
# Notes
# ========================================

# Local Development (minimal setup):
#   - Set DEBUG=true
#   - Set REDIS_OPTIONAL=true
#   - Don't start Redis or Celery
#   - Upload API works, but analysis/generation won't run
#   - Use: uvicorn app.main:app --port 8000 (no --reload if file watch issues)

# Full Local Development:
#   - Set DEBUG=true
#   - Start Redis: redis-server
#   - Start Celery: celery -A app.celery_worker worker --loglevel=info
#   - Start FastAPI: uvicorn app.main:app --reload --port 8000

# Production:
#   - Set DEBUG=false
#   - Set REDIS_OPTIONAL=false
#   - Use managed Redis (Railway, AWS ElastiCache, etc.)
#   - Set strong SECRET_KEY
#   - Use production CORS_ORIGINS
